name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'
          severity: warning
          ignore_paths: .git

  test-bootstrap-macos:
    name: Test Bootstrap on macOS
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          # Stow should already be available via Homebrew on GitHub runners
          brew install stow

      - name: Verify help flag
        run: |
          ./bootstrap.sh --help

      - name: Run bootstrap (without Homebrew install)
        run: |
          # Run bootstrap but skip the Homebrew bundle install prompt
          # by only stowing specific safe packages
          ./bootstrap.sh git zsh starship asdf

      - name: Verify symlinks created
        run: |
          # Check that symlinks were created
          test -L ~/.gitconfig || (echo "~/.gitconfig not symlinked" && exit 1)
          test -L ~/.zshrc || (echo "~/.zshrc not symlinked" && exit 1)
          test -L ~/.config/starship.toml || (echo "~/.config/starship.toml not symlinked" && exit 1)
          test -L ~/.tool-versions || (echo "~/.tool-versions not symlinked" && exit 1)
          echo "All symlinks verified!"

      - name: Test cleanup with stow -D
        run: |
          cd $GITHUB_WORKSPACE
          stow -D git zsh starship asdf
          # Verify symlinks removed
          test ! -L ~/.gitconfig || (echo "~/.gitconfig still exists" && exit 1)
          test ! -L ~/.zshrc || (echo "~/.zshrc still exists" && exit 1)
          echo "Cleanup successful!"
